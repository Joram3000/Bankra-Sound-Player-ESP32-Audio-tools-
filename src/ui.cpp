// ui.cpp - display + scope implementation moved out of bankrasampler.cpp
#include "ui.h"
#include "config.h"

#include <AudioTools.h>
#include <Wire.h>

#if DISPLAY_DRIVER == DISPLAY_DRIVER_ADAFRUIT_SSD1306
  #include <Adafruit_GFX.h>
  #include <Adafruit_SSD1306.h>
  #include <ScopeDisplay.h>
  
#elif DISPLAY_DRIVER == DISPLAY_DRIVER_U8G2_SSD1306
  #include <U8g2lib.h>
  #include <ScopeDisplayU8g2.h>
#ifndef DISPLAY_U8G2_CLASS
  #define DISPLAY_U8G2_CLASS U8G2_SSD1306_128X64_NONAME_F_HW_I2C
#endif
#ifndef DISPLAY_U8G2_CTOR_ARGS
  #define DISPLAY_U8G2_CTOR_ARGS U8G2_R0, U8X8_PIN_NONE
#endif
#else
  #error "Unsupported DISPLAY_DRIVER selection"
#endif

static int16_t waveformBuffer[NUM_WAVEFORM_SAMPLES];
static int waveformIndex = 0;

#if DISPLAY_DRIVER == DISPLAY_DRIVER_ADAFRUIT_SSD1306
  static Adafruit_SSD1306 display(DISPLAY_WIDTH, DISPLAY_HEIGHT, &Wire, -1);
  static ScopeDisplay scopeDisplay(&display, waveformBuffer, &waveformIndex, NUM_WAVEFORM_SAMPLES);
#elif DISPLAY_DRIVER == DISPLAY_DRIVER_U8G2_SSD1306
  static DISPLAY_U8G2_CLASS display(DISPLAY_U8G2_CTOR_ARGS);
  static ScopeDisplayU8g2 scopeDisplay(&display, waveformBuffer, &waveformIndex, NUM_WAVEFORM_SAMPLES);
#endif

ScopeI2SStream scopeI2s(waveformBuffer, &waveformIndex, scopeDisplay.getMutex());

bool initUi() {
#if DISPLAY_DRIVER == DISPLAY_DRIVER_U8G2_SSD1306
  Serial.println(F("[UI] Using U8g2 display backend"));
#else
  Serial.println(F("[UI] Using Adafruit SSD1306 backend"));
#endif
  if (!scopeDisplay.begin(DISPLAY_I2C_ADDRESS)) {
    Serial.println(F("Display init failed"));
    return false;
  }
  return true;
}

void updateUi(bool playing, const String& filename) {
  static bool lastPlayingState = false;
  static String lastFileName = "";
  String fn = filename;
  if (fn.isEmpty()) fn = "-";
  if (playing != lastPlayingState || fn != lastFileName) {
    lastPlayingState = playing;
    lastFileName = fn;
    scopeDisplay.updateStatus(playing, fn);
  }
}

U8G2* getU8g2Display() {
#if DISPLAY_DRIVER == DISPLAY_DRIVER_U8G2_SSD1306
  return &display;
#else
  return nullptr;
#endif
}

void* getDisplayMutex() {
#if DISPLAY_DRIVER == DISPLAY_DRIVER_U8G2_SSD1306
  return scopeDisplay.getMutex();
#else
  return nullptr;
#endif
}

void setScopeHorizZoom(float z) {
#if DISPLAY_DRIVER == DISPLAY_DRIVER_U8G2_SSD1306
  scopeDisplay.setHorizZoom(z);
#else
  (void)z;
#endif
}

void setScopeDisplaySuspended(bool suspended) {
#if DISPLAY_DRIVER == DISPLAY_DRIVER_U8G2_SSD1306
  scopeDisplay.setSuspended(suspended);
#else
  scopeDisplay.setSuspended(suspended);
#endif
}
